<!DOCTYPE html>
<head>
    <title>RPG</title>
    <script src=https://code.jquery.com/jquery-3.6.0.min.js></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <link href="/css/my.css" rel="stylesheet">
    <meta content="text/html" charset="utf-8"/>
</head>
<body>
<div class="container">
    <h1>RPG admin panel</h1>
    <div>
        <select name="select-count" id="count-per-page" onchange="currentPage = 0; changeCountPerPage()">
        </select>
    </div>
    <table id="table-players">
        <thead>
        <tr>
            <th>#</th>
            <th>Name</th>
            <th>Title</th>
            <th>Race</th>
            <th>Profession</th>
            <th>Level</th>
            <th>Birthday</th>
            <th>Banned</th>
            <th>Edit</th>
            <th>Delete</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
    <div id="pagination">Pages:</div>
    <br>

    <form class="form-player" action="/rest/players" method="post">
        <h3>Create new account</h3>
        <div class="mb-3">
            <label for="name" class="form-label">Name:</label>
            <input id="name" type="text" class="form-control">
        </div>

        <div class="mb-3">
            <label for="title" class="form-label">Title:</label>
            <input id="title" type="text" class="form-control">
        </div>

        <div class="mb-3">
            <label for="race" class="form-label">Race:</label>
            <select name="race" id="race" class="form-control"></select>
        </div>

        <label for="profession" class="form-label">Profession:</label>
        <select name="profession" id="profession" class="form-control"></select>

        <label for="level" class="form-label">Level:</label>
        <input id="level" type="text" class="form-control">

        <label for="birthday" class="form-label">Birthday:</label>
        <input id="birthday" type="date" class="form-control">

        <label for="banned" class="form-label">Banned:</label>
        <select name="banned" id="banned" class="form-control"></select>
    </form>

</div>

<script>
    let countPlayers = 0;
    let countPerPage = 3;
    let currentPage = 0;
    const RACES = [
        {value: "HUMAN", text: "HUMAN"},
        {value: "DWARF", text: "DWARF"},
        {value: "ELF", text: "ELF"},
        {value: "GIANT", text: "GIANT"},
        {value: "ORC", text: "ORC"},
        {value: "TROLL", text: "TROLL"},
        {value: "HOBBIT", text: "HOBBIT"}
    ]
    const PROFESSIONS = [
        {value: "WARRIOR", text: "WARRIOR"},
        {value: "ROGUE", text: "ROGUE"},
        {value: "SORCERER", text: "SORCERER"},
        {value: "CLERIC", text: "CLERIC"},
        {value: "PALADIN", text: "PALADIN"},
        {value: "NAZGUL", text: "NAZGUL"},
        {value: "WARLOCK", text: "WARLOCK"},
        {value: "DRUID", text: "DRUID"}
    ]
    const BANNED = [
        {value: "true", text: "true"},
        {value: "false", text: "false"}
    ]

    $(document).ready(function () {
        getCountPlayers(); // Получение общего числа игроков
        createFormPlayer() // Создание полей для формы на создание игрока
    })

    function getCountPlayers() {
        $.ajax({
            url: "rest/players/count",
            method: "GET",
            dataType: "text",
            success: function (data) {
                // data - количество игроков
                countPlayers = data;
                // Выпадающее меню с выбором отображаемого списка
                for (let i = 3; i < 21; i++) {
                    $('#count-per-page').append($('<option>').attr("value", i).text(i));
                }
                updateCountPerPage(); // Получение числа игроков на странице
                getCountPages(); // Обновление пагинации
                getPlayers(); // Запрос на получение листа игроков
            }
        })
    }

    function createFormPlayer() {
        // options для RACE
        $.each(RACES, function (_, option) {
            $('#race').append($('<option>', {
                value: option.value,
                text: option.text
            }))
        })

        // options для Profession
        $.each(PROFESSIONS, function (_, option) {
            $('#profession').append($('<option>', {
                value: option.value,
                text: option.text
            }))
        })

        // options для Banned
        $.each(BANNED, function (_, option) {
            $('#banned').append($('<option>', {
                value: option.value,
                text: option.text
            }))
        })
    }


    function changeCountPerPage() {
        updateCountPerPage();
        getCountPages(); // Обновление пагинации
        getPlayers(); // Запрос на получение листа игроков
    }

    function updateCountPerPage() {
        // Обновление числа отображаемого списка
        countPerPage = $('#count-per-page').val();
    }


    function getPlayers() {
        $.ajax({
            url: "rest/players/",
            method: "get",
            dataType: 'json',
            data: {
                pageNumber: currentPage,
                pageSize: countPerPage
            },
            success: function (response) {
                // Очищаем тело таблицы
                $('#table-players tbody').empty();

                $.each(response, function (index, player) {
                    let date = new Date(player.birthday),
                        year = '' + date.getFullYear(),
                        month = '' + (date.getMonth() + 1),
                        day = '' + date.getDate();
                    let formatDate = [month, day, year].join('/');

                    let row = $('<tr>');
                    row.append($('<td>').addClass("id").text(player.id));
                    row.append($('<td>').addClass("name text-field").text(player.name));
                    row.append($('<td>').addClass("title text-field").text(player.title));
                    row.append($('<td>').addClass("race").text(player.race));
                    row.append($('<td>').addClass("profession").text(player.profession));
                    row.append($('<td>').addClass("level").text(player.level));
                    row.append($('<td>').addClass("formatDate").text(formatDate));
                    row.append($('<td>').addClass("banned").text(player.banned));
                    row.append($('<td>').append($('<button>').addClass("btn-img-edit")
                        .click(function (event) {
                            toggleBtnEdit(event.currentTarget, player);
                        })
                    ));
                    row.append($('<td>').append($('<button>').addClass("btn-img-delete")
                        .click(() => deletePlayer(player.id)
                        )));

                    $('#table-players tbody').append(row);

                })
            }
        })
    }

    function updatePlayer(player) {
        // Исключаем ненужные поля и передаем в filteredObj
        const {id, level, birthday, ...filteredObj} = player;

        $.ajax({
            url: `rest/players/${player.id}`,
            method: "POST",
            contentType: "application/json",
            dataType: "json",
            data: JSON.stringify(filteredObj),
            success: function () {
                getPlayers();
            }
        })
    }

    function toggleBtnEdit(button, player) {
        const $button = $(button);
        const $row = $button.closest('tr');
        const $deleteButton = $row.find('.btn-img-delete');

        $button.toggleClass("editable");

        if ($button.hasClass("editable")) {
            $deleteButton.hide();
            switchToFormPlayer(button);
        } else {
            $deleteButton.show();
            player.name = $row.find('.name input').val();
            player.title = $row.find('.title input').val();
            player.race = $row.find('.race select').val();
            player.profession = $row.find('.profession select').val();
            player.banned = $row.find('.banned select').val();

            updatePlayer(player);

        }
    }

    function transformToSelectField(button, classField, optionsArrayObject) {
        // Преобразование поля classField в select
        const $tdSelectField = $(button).closest('tr').find('.' + classField);
        const value = $tdSelectField.text();

        const $select = $('<select>');
        $.each(optionsArrayObject, function (_, option) {
            $select.append($('<option>', {
                value: option.value,
                text: option.text,
                selected: option.text === value
            }))
        })
        $tdSelectField.html($select);
    }

    function switchToFormPlayer(button) {
        // Преобразование в Input поля - name и title
        const $tdTextField = $(button).closest('tr').find('.text-field');
        $tdTextField.each(function () {
            const value = $(this).text();
            $(this).html('<input type="text" value="' + value + '">');
        });


        transformToSelectField(button, "race", RACES);
        transformToSelectField(button, "profession", PROFESSIONS);
        transformToSelectField(button, "banned", BANNED);
    }

    function getCountPages() {
        // Очищаем предыдущее количество страниц
        $('#pagination').empty();

        $('#pagination').text("Pages");
        // Задаем количество страниц в зависимости от выбранного отображаемого кол-ва игроков на странице
        for (let i = 0; i < (countPlayers / countPerPage); i++) {
            const activePage = i === currentPage ? 'active' : '';
            $('#pagination').append($('<button>').addClass("page").addClass(activePage).text(i + 1).click(function () {
                currentPage = i;
                changeCountPerPage();
            }));
        }
    }

    function deletePlayer(id) {
        $.ajax({
            method: "DELETE",
            url: `rest/players/${id}`,
            success: function () {
                countPlayers -= 1;
                if (currentPage === countPlayers / countPerPage) {
                    currentPage -= 1;
                }
                getCountPlayers();
            }
        })
    }

</script>
</body>
</html>