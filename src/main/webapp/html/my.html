<html>
<head>
    <title>RPG</title>
    <script src=https://code.jquery.com/jquery-3.6.0.min.js></script>
    <link href="/css/my.css" rel="stylesheet">
    <meta content="text/html" charset="utf-8"/>
</head>
<body>
<h1>RPG admin panel</h1>
<div>
    <select name="select-count" id="count-per-page" onchange="currentPage = 0; changeCountPerPage()">
    </select>
</div>
<table id="table-players">
    <thead>
    <tr>
        <th>#</th>
        <th>Name</th>
        <th>Title</th>
        <th>Race</th>
        <th>Profession</th>
        <th>Level</th>
        <th>Birthday</th>
        <th>Banned</th>
        <th>Edit</th>
        <th>Delete</th>
    </tr>
    </thead>
    <tbody>

    </tbody>
</table>
<div id="pagination">Pages:</div>

<script>
    let countPlayers = 0;
    let countPerPage = 3;
    let currentPage = 0;

    $(document).ready(function () {
        getCountPlayers(); // Получение общего числа игроков
    })

    function getCountPlayers() {
        $.ajax({
            url: "rest/players/count",
            method: "GET",
            dataType: "text",
            success: function (data) {
                // data - количество игроков
                countPlayers = data;
                // Выпадающее меню с выбором отображаемого списка
                for (let i = 3; i < 21; i++) {
                    $('#count-per-page').append($('<option>').attr("value", i).text(i));
                }
                updateCountPerPage(); // Получение числа игроков на странице
                getCountPages(); // Обновление пагинации
                getPlayers(countPerPage); // Запрос на получение листа игроков
            }
        })
    }

    function changeCountPerPage() {
        updateCountPerPage();
        getCountPages(); // Обновление пагинации
        getPlayers(countPerPage); // Запрос на получение листа игроков
    }

    function updateCountPerPage() {
        // Обновление числа отображаемого списка
        countPerPage = $('#count-per-page').val();
    }


    function getPlayers(count) {
        $.ajax({
            url: "rest/players/",
            method: "get",
            dataType: 'json',
            data: {
                pageNumber: currentPage,
                pageSize: count
            },
            success: function (response) {
                // Очищаем тело таблицы
                $('#table-players tbody').empty();

                const $form = $('<form>', {
                    method: "post"
                });

                $.each(response, function (index, player) {
                    let date = new Date(player.birthday),
                        year = '' + date.getFullYear(),
                        month = '' + (date.getMonth() + 1),
                        day = '' + date.getDate();
                    let formatDate = [month, day, year].join('/');

                    let row = $('<tr>');
                    row.append($('<td>').addClass("id").text(player.id));
                    row.append($('<td>').addClass("name text-field").text(player.name));
                    row.append($('<td>').addClass("title text-field").text(player.title));
                    row.append($('<td>').addClass("race").text(player.race));
                    row.append($('<td>').addClass("profession").text(player.profession));
                    row.append($('<td>').addClass("level").text(player.level));
                    row.append($('<td>').addClass("formatDate").text(formatDate));
                    row.append($('<td>').addClass("banned").text(player.banned));
                    row.append($('<td>').append($('<button>').addClass("btn-img-edit")
                        .click(function (event) {
                            toggleBtnEdit(event.currentTarget, player);
                        })
                    ));
                    row.append($('<td>').append($('<button>').addClass("btn-img-delete")
                        .click(() => deletePlayer(player.id)
                        )));

                    $('#table-players tbody').append(row);

                })
            }
        })
    }

    function updatePlayer(player) {
        // Исключаем ненужные поля и передаем в filteredObj
        const {id, level, birthday, ...filteredObj} = player;

        $.ajax({
            url: `rest/players/${player.id}`,
            method: "POST",
            contentType: "application/json",
            dataType: "json",
            data: JSON.stringify(filteredObj),
            success: function (data) {
                console.log(data);
            }
        })
    }

    function toggleBtnEdit(button, player) {
        const $button = $(button);
        const $row = $button.closest('tr');
        const $deleteButton = $row.find('.btn-img-delete');

        $button.toggleClass("editable");

        if ($button.hasClass("editable")) {
            $deleteButton.hide();
            switchToFormPlayer(button);
        } else {
            $deleteButton.show();
            player.name = $row.find('name input').val();
            player.title = $row.find('title').text();
            player.race = $row.find('race').text();
            player.profession = $row.find('profession').text();
            player.banned = $row.find('banned').text();
            updatePlayer(player);
        }
    }

    function transformToSelectField(button, classField, optionsArrayObject) {
        // Преобразование поля classField в select
        const $tdSelectField = $(button).closest('tr').find('.' + classField);
        const valRace = $tdSelectField.text();

        const $select = $('<select>');
        $.each(optionsArrayObject, function (_, option) {
            $select.append($('<option>', {
                value: option.value,
                text: option.text,
                selected: option.text === valRace
            }))
        })
        $tdSelectField.html($select);
    }

    function switchToFormPlayer(button) {
        // Преобразование в Input поля - name и title
        const $tdTextField = $(button).closest('tr').find('.text-field');
        $tdTextField.each(function () {
            const value = $(this).text();
            $(this).html('<input type="text" value="' + value + '">');
        });
        const optionsRace = [
            {value: "HUMAN", text: "HUMAN"},
            {value: "DWARF", text: "DWARF"},
            {value: "ELF", text: "ELF"},
            {value: "GIANT", text: "GIANT"},
            {value: "ORC", text: "ORC"},
            {value: "TROLL", text: "TROLL"},
            {value: "HOBBIT", text: "HOBBIT"}
        ]
        const optionsProfession = [
            {value: "WARRIOR", text: "WARRIOR"},
            {value: "ROGUE", text: "ROGUE"},
            {value: "SORCERER", text: "SORCERER"},
            {value: "CLERIC", text: "CLERIC"},
            {value: "PALADIN", text: "PALADIN"},
            {value: "NAZGUL", text: "NAZGUL"},
            {value: "WARLOCK", text: "WARLOCK"},
            {value: "DRUID", text: "DRUID"}
        ]
        const optionsBool = [
            {value: "true", text: "true"},
            {value: "false", text: "false"}
        ]
        transformToSelectField(button, "race", optionsRace);
        transformToSelectField(button, "profession", optionsProfession);
        transformToSelectField(button, "banned", optionsBool);
    }

    function getCountPages() {
        // Очищаем предыдущее количество страниц
        $('#pagination').empty();

        $('#pagination').text("Pages");
        // Задаем количество страниц в зависимости от выбранного отображаемого кол-ва игроков на странице
        for (let i = 0; i < (countPlayers / countPerPage); i++) {
            const activePage = i === currentPage ? 'active' : '';
            $('#pagination').append($('<button>').addClass("page").addClass(activePage).text(i + 1).click(function () {
                currentPage = i;
                changeCountPerPage();
            }));
        }
    }

    function deletePlayer(id) {
        $.ajax({
            method: "DELETE",
            url: `rest/players/${id}`,
            success: function () {
                countPlayers -= 1;
                if (currentPage === countPlayers / countPerPage) {
                    currentPage -= 1;
                }
                getCountPlayers();
            }
        })
    }

</script>
</body>
</html>